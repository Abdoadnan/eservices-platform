(function(){var Builder,Controls,Document,Event,Events,FSM,OD,YD;Builder=ORBEON.Builder;Controls=ORBEON.xforms.Controls;Document=ORBEON.xforms.Document;Event=YAHOO.util.Event;Events=ORBEON.xforms.Events;FSM=ORBEON.util.FiniteStateMachine;OD=ORBEON.util.Dom;YD=YAHOO.util.Dom;$(function(){var anyEditableSelector,currentSeqNo,editDoneCallbacks,editable,editableDo,editableEditInput,editableInitialValue,editableInside,editablePlaceholderContainer,editablePlaceholderOutput,editables,isEmpty,pointerInsideCell,setFocus;editables={button:{selector:".fr-grid-content > .xforms-trigger-appearance-full",editInputSelector:"#fb-edit-label",placeholderOutputSelector:".fb-message-enter-label",placeholderContainerSelector:"span.btn",initialValueSelector:"button",createMock:function(element){var button,mockButton;button=f$.find("button",element);f$.hide(button);mockButton=f$.appendTo(element,$('<span class="btn">'));return mockButton.text(f$.text(button));},removeMock:function(element){f$.show(f$.find("button",element));return f$.remove(f$.find("span.btn",element));}},link:{selector:".fr-grid-content > .xforms-trigger-appearance-minimal",editInputSelector:"#fb-edit-label",placeholderOutputSelector:".fb-message-enter-label",placeholderContainerSelector:".fb-mock-link",initialValueSelector:"a",createMock:function(element){var anchor,mockLink;anchor=f$.find("a",element);f$.hide(anchor);f$.appendTo(element,(mockLink=$('<div class="fb-mock-link">')));return mockLink.text(f$.text(anchor));},removeMock:function(element){f$.show(f$.find("a",element));return f$.remove(f$.find(".fb-mock-link",element));}}};anyEditableSelector=_.pluck(_.values(editables),"selector");editable=function(element){return _.first(_.filter(_.values(editables),function(e){return f$.is("*",f$.findOrIs(e.selector,element));}));};editableEditInput=(function(){var selectorToInput;selectorToInput=_.memoize(function(selector){return $(selector);});return function(element){return selectorToInput((editable(element)).editInputSelector);};})();editablePlaceholderOutput=function(element){return $((editable(element)).placeholderOutputSelector);};editableInside=function(selectorType,element){return f$.findOrIs((editable(element))[selectorType],element);};editablePlaceholderContainer=function(element){return editableInside("placeholderContainerSelector",element);};editableInitialValue=function(element){return editableInside("initialValueSelector",element);};editableDo=function(actionName){return function(element){var action;action=(editable(element))[actionName];if(action){return action(element);}};};currentSeqNo=function(element){var form;form=f$.closest("form",element);return parseInt(Document.getFromClientState(f$.attr("id",form),"sequence"));};setFocus=function(element){var deferred,setFocusWorker;deferred=$.Deferred();(setFocusWorker=function(){var focusSet;f$.focus(element);focusSet=document.activeElement===element[0];if(focusSet){return deferred.resolve();}else{return _.defer(setFocusWorker);}})();return deferred;};editDoneCallbacks=$.Callbacks();return FSM.create({transitions:[{events:["mouseEntersGridTd"],elements:"elementsInContainer",from:["initial"],conditions:["isEmpty"],to:"placeholder",actions:["removeFor","createMock","showPlaceholder"]},{events:["mouseEntersGridTd"],elements:"elementsInContainer",from:["initial"],conditions:["isNonEmpty"],to:"mock",actions:["removeFor","createMock"]},{events:["mouseExistsGridTd"],elements:"elementsInContainer",from:["mock"],to:"initial",actions:["removeMock"]},{events:["mouseExistsGridTd"],elements:"elementsInContainer",from:["placeholder"],to:"initial",actions:["hidePlaceholder","removeMock"]},{events:["click"],elements:"elementClosest",from:["placeholder","mock"],to:"wait-xhr-to-edit",actions:["storeSeqNo"]},{events:["controlAdded"],elements:"elementsAll",from:["edit"],to:"edit-done",actions:["endEdit","removeMock","fireEditDone"]},{events:["controlAdded"],elements:"labelsInContainer",from:["initial"],to:"edit",actions:["removeFor","createMock","startEdit"]},{events:["ajaxResponse"],elements:"elementsAll",from:["wait-xhr-to-edit"],conditions:["isNextSeqNo"],to:"edit",actions:["startEdit"]},{events:["enterKey","lostFocus"],elements:"elementClosest",from:["edit"],to:"edit-done",actions:["endEdit","removeMock","fireEditDone"]},{events:["editDone"],elements:"elementsAll",from:["edit-done"],conditions:["pointerOutsideCell"],to:"initial"},{events:["editDone"],elements:"elementsAll",from:["edit-done"],conditions:["pointerInsideCell","isEmpty"],to:"placeholder-after-edit",actions:["storeSeqNo","createMock","showPlaceholder"]},{events:["editDone"],elements:"elementsAll",from:["edit-done"],conditions:["pointerInsideCell","isNonEmpty"],to:"mock",actions:["createMock"]},{events:["ajaxResponse"],elements:"elementsAll",from:["placeholder-after-edit"],conditions:["isNextSeqNo"],to:"placeholder",actions:["showPlaceholder"]}],events:{mouseEntersGridTd:function(f){return Builder.mouseEntersGridTdEvent.subscribe(function(_arg){var gridTd;gridTd=_arg.gridTd;return f($(gridTd));});},mouseExistsGridTd:function(f){return Builder.mouseExitsGridTdEvent.subscribe(function(_arg){var gridTd;gridTd=_arg.gridTd;return f($(gridTd));});},controlAdded:function(f){return Builder.controlAdded.add(function(containerId){return f($(document.getElementById(containerId)));});},ajaxResponse:function(f){return Events.ajaxResponseProcessedEvent.subscribe(f);},click:function(f){return($(document)).click(function(_arg){var target;target=_arg.target;return f($(target));});},enterKey:function(f){return($(document)).keypress(function(_arg){var target,which;target=_arg.target,which=_arg.which;if(which===13){return f($(target));}});},lostFocus:function(f){return($(document)).focusout(function(_arg){var target;target=_arg.target;if(f$.is(".fb-edit-label, .fb-edit-hint",f$.parent($(target)))){return f($(target));}});},editDone:function(f){return editDoneCallbacks.add(f);}},elements:(function(){var adjustContainerForRepeat,elementsInContainerWithSelector;adjustContainerForRepeat=function(container){var grid,position,thContainer;grid=f$.closest(".fr-grid",container);if(f$.is(".fr-repeat-single-row",grid)){position=1+f$.length(f$.prevAll(container));thContainer=f$.nth(position,f$.children(f$.find("tr.fr-grid-master-row",grid)));return f$.add(thContainer,container);}else{return container;}};elementsInContainerWithSelector=function(container,selectors){return f$.find(selectors.join(", "),adjustContainerForRepeat(container));};return{elementsInContainer:function(container){return elementsInContainerWithSelector(container,anyEditableSelector);},labelsInContainer:function(container){var labelLikeEditables;labelLikeEditables=_.pick(editables,["label","button","link"]);return elementsInContainerWithSelector(container,_.pluck(labelLikeEditables,"selector"));},elementClosest:function(element){return f$.closest(anyEditableSelector.join(", "),element);},elementsAll:function(){var selectors;selectors=_.map(anyEditableSelector,function(s){return".fr-editable "+s;});selectors=selectors.join(", ");return $(selectors);}};})(),conditions:{isEmpty:isEmpty=function(element){return(f$.text(editableInitialValue(element)))==="";},isNonEmpty:function(element){return !isEmpty(element);},pointerInsideCell:pointerInsideCell=(function(){var currentCell;currentCell=null;Builder.mouseEntersGridTdEvent.subscribe(function(_arg){var gridTd;gridTd=_arg.gridTd;return currentCell=gridTd;});Builder.mouseExitsGridTdEvent.subscribe(function(){return currentCell=null;});return function(element){return(currentCell!=null)&&f$.is("*",f$.closest(currentCell,element));};})(),pointerOutsideCell:function(element){return !pointerInsideCell(element);},isNextSeqNo:function(element){var storeSeqNo;storeSeqNo=parseInt(f$.data("seqNo",element));return(currentSeqNo(element))===storeSeqNo+1;}},actions:{removeFor:function(element){return f$.removeAttr("for",element);},showPlaceholder:function(element){var placeholderText;f$.addClass("fb-label-hint-placeholder",element);placeholderText=Controls.getCurrentValue(_.first(editablePlaceholderOutput(element)));return f$.text(placeholderText,editablePlaceholderContainer(element));},hidePlaceholder:function(element){f$.removeClass("fb-label-hint-placeholder",element);return f$.text("",editablePlaceholderContainer(element));},createMock:editableDo("createMock"),removeMock:editableDo("removeMock"),storeSeqNo:function(element){return f$.data("seqNo",currentSeqNo(element),element);},startEdit:function(element){var htmlInput,input,saveButton;Builder.beforeAddingEditorCallbacks.fire(element);f$.removeClass("fb-label-hint-placeholder",element);f$.removeClass("xforms-disabled",element);input=editableEditInput(element);f$.append(input,f$.empty(editablePlaceholderContainer(element)));f$.show(input);htmlInput=f$.find("input",input);saveButton=$(".fr-save-button button");return(setFocus(saveButton)).then(function(){return setFocus(htmlInput);});},endEdit:function(element){var input,newValue;input=editableEditInput(element);f$.append(input,$(".fb-cell-editor"));newValue=Controls.getCurrentValue(input[0]);return f$.text(newValue,editableInitialValue(element));},fireEditDone:function(){return editDoneCallbacks.fire();}}});});}).call(this);