(function(){$(function(){var Builder,ControlSelector,Events,LabelHintSelector,OD,annotateWithLhhaClass,clickOrFocus,currentControl,currentLabelHint,endEdit,htmlClass,isLabelHintHtml,labelHintEditor,labelHintValue,lhha,setLabelHintHtml,startEdit;Builder=ORBEON.Builder;Events=ORBEON.xforms.Events;OD=ORBEON.xforms.Document;LabelHintSelector=".fr-editable .xforms-label, .fr-editable .xforms-hint";ControlSelector=".xforms-control, .xbl-component";currentControl=null;currentLabelHint=null;lhha=function(){if(currentLabelHint.is(".xforms-label")){return"label";}else{return"hint";}};htmlClass=function(){return"fb-"+lhha()+"-is-html";};isLabelHintHtml=function(){return currentControl.is("."+htmlClass());};setLabelHintHtml=function(isHtml){return currentControl.toggleClass(htmlClass(),isHtml);};annotateWithLhhaClass=function(add){return labelHintEditor().container.toggleClass("fb-label-editor-for-"+lhha(),add);};labelHintValue=function(value){var valueAccessor;valueAccessor=isLabelHintHtml()?currentLabelHint.html:currentLabelHint.text;valueAccessor=_.bind(valueAccessor,currentLabelHint);if(value!=null){return valueAccessor(value);}else{return valueAccessor();}};endEdit=function(){var isChecked,newValue;if(labelHintEditor().container.is(":visible")){newValue=labelHintEditor().textfield.val();isChecked=labelHintEditor().checkbox.is(":checked");OD.dispatchEvent({targetId:currentControl.attr("id"),eventName:"fb-update-control-lhha",properties:{lhha:lhha(),value:newValue,isHtml:isChecked.toString()}});labelHintEditor().checkbox.tooltip("destroy");labelHintEditor().container.hide();annotateWithLhhaClass(false);currentLabelHint.css("visibility","");setLabelHintHtml(isChecked);labelHintValue(newValue);currentControl=null;return currentLabelHint=null;}};clickOrFocus=function(_arg){var eventOnControlLabel,eventOnEditor,target;target=_arg.target;target=$(target);eventOnEditor=labelHintEditor().textfield.is(target)||labelHintEditor().checkbox.is(target);eventOnControlLabel=(target.is(LabelHintSelector)||target.parents(LabelHintSelector).is("*"))&&target.parents(".fb-main").is("*");if(!(eventOnEditor||eventOnControlLabel)){return endEdit();}};labelHintEditor=_.memoize(function(){var editor;editor={};editor.textfield=$('<input type="text">');editor.checkbox=$('<input type="checkbox">');editor.container=$('<div class="fb-label-editor">').append(editor.textfield).append(editor.checkbox);$(".fb-main").append(editor.container);editor.checkbox.on("click",function(){return labelHintEditor().textfield.focus();});editor.textfield.on("keypress",function(e){if(e.which===13){return endEdit();}});$(document).on("click",clickOrFocus);$(document).on("focusin",clickOrFocus);return editor;});startEdit=function(){var labelHintOffset;currentLabelHint.removeAttr("for");labelHintOffset=currentLabelHint.offset();labelHintEditor().container.show();labelHintEditor().container.offset(labelHintOffset);labelHintEditor().container.width(currentLabelHint.outerWidth());labelHintEditor().textfield.outerWidth(currentLabelHint.outerWidth()-labelHintEditor().checkbox.outerWidth(true));labelHintEditor().textfield.val(labelHintValue()).focus();labelHintEditor().checkbox.prop("checked",isLabelHintHtml());labelHintEditor().checkbox.tooltip({title:$(".fb-lhha-checkbox-message").text()});labelHintEditor().textfield.attr("placeholder",$(".fb-"+(lhha())+"-placeholder").text());currentLabelHint.css("visibility","hidden");return annotateWithLhhaClass(true);};$(".fb-main").on("click",LabelHintSelector,function(_arg){var currentTarget,tdWithControl,th,trWithControls;currentTarget=_arg.currentTarget;if(!_.isNull(currentControl)){endEdit();}currentLabelHint=$(currentTarget);th=currentLabelHint.parents("th");currentControl=th.is("*")?(trWithControls=th.parents("table").find("tbody tr.fb-grid-tr").first(),tdWithControl=trWithControls.children(":nth-child("+(th.index()+1)+")"),tdWithControl.find(ControlSelector)):currentLabelHint.parents(ControlSelector).first();return startEdit();});Builder.controlAdded.add(function(containerId){var container,repeat;container=$(document.getElementById(containerId));currentControl=container.find(ControlSelector);repeat=container.parents(".fr-repeat").first();currentLabelHint=repeat.is("*")?repeat.find("thead tr th:nth-child("+(container.index()+1)+") .xforms-label"):container.find(".xforms-label");return startEdit();});return(function(){var gridTdUpdated,lhhaNames,placeholderText,updateGridTd,updatePlacehodlerText;lhhaNames=["label","hint"];gridTdUpdated=[];placeholderText={};updateGridTd=function(gridTd){gridTd=$(gridTd);return _.each(lhhaNames,function(lhha){var elementInDiv;elementInDiv=gridTd.find(".xforms-"+lhha);return elementInDiv.attr("placeholder",placeholderText[lhha]);});};updatePlacehodlerText=function(){var foundDifference,isInDoc;foundDifference=false;_.each(lhhaNames,function(lhha){var newText;newText=$("#fb-placeholder-"+lhha).children().text();if(newText!==placeholderText[lhha]){placeholderText[lhha]=newText;return foundDifference=true;}});if(foundDifference){isInDoc=function(e){return $.contains(document.body,e);};gridTdUpdated=_.filter(gridTdUpdated,isInDoc);return _.each(gridTdUpdated,updateGridTd);}};updatePlacehodlerText();Events.ajaxResponseProcessedEvent.subscribe(updatePlacehodlerText);return Builder.mouseEntersGridTdEvent.subscribe(function(_arg){var gridTd;gridTd=_arg.gridTd;if(!_.contains(gridTdUpdated,gridTd)){gridTdUpdated.push(gridTd);return updateGridTd(gridTd);}});})();});}).call(this);