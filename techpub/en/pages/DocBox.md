# DocBox API #

## Beskrivning ##
DocBox är en tjänst för att konvertera ett ifyllt formulär från XML-format till PDF/A och att sedan hantera signering av PDF-dokumentet.

Det finns också ett rudimentärt gui för att inspektera databasen och ladda ner dokument.

## Configuration ##

For database configuration, see DocBoxGetStarted. Also add properties to the configuration file according to the following example.

```
// Strict check that signed text contains the document number and the checksum?
// Lenient if false, otherwise strict.
docbox.signed.text.check.strict = true

// Base url used in QR code. A docboxRef is appended for a complete url.
// The QR code is not generated if this property is empty.
docbox.signed.doc.base.url = https://eservice.malmo.se/site/public/mycases/signform/view
```

## REST API ##

Items with a dollar sign are variables to be provided by the caller.

### Create PDF/A from Form Instance ###


```
PUT /docbox/doc/formdata/$formDataUuid
```

Create a PDF/A document from a form instance identified by *formDataUuid* unless there already is one, or find the latest step of a document identified by *formDataUuid*. In either case, return a JSON structure containing document metadata (example, newlines added for clarity),

```
{"formDataUuid":"03746e2485b44dcf1e1abf00a2258acaa3b1a474",
 "docboxRef":"8292cd8c-c0cd-4773-a601-c82a9bb88afc",
 "docNo":"8SJPTG-0",
 "signCount":0,
 "checkSum":"TykqFBx/6cYORsnIN5qFwugohuUTtZ7i/x9PV0T6ncI="
}
```
where

* **formDataUuid**  
 The formDataUuid identifying the original form instance
* **docboxRef**  
 A reference to the created document (including step)
* **docNo**  
 A document number identifying this document
* **signCount**  
 The number of signatures in the document (zero in a new document)
* **checkSum**  
 A cryptographic hash of the contents of the document

#### HTTP Status & Errors ####

The method returns one of the following HTTP status codes,

* 200 (OK) if the document already exists
* 201 (Created) if it did not exist and was created
* 404 (Not found) if the form instance was not found
* 409 (Conflict) if the PDF conversion failed

In case of a conflict during PDF conversion, a JSON structure is returned.

```
{"formDataUuid":"03746e2485b44dcf1e1abf00a2258acaa3b1a474",
 "conflictMessage":"...usually a long text..."
}
```

The conflict message is not a wonder of clarity. It contains all output from the PDF conversion, including warnings that may be ignored.

A common cause for PDF conversion failure is that an image contains transparency which is not allowed in PDF/A-1a. The original file name is not visible in the message, only the uuid assigned by Orbeon.

### Get Document ###

A document may be identified in several ways, so there are several `GET` methods.

```
GET /docbox/doc/formdata/$formDataUuid
GET /docbox/doc/ref/$docboxRef
```

Get a document from the database. All methods return status 200 and a document, or status 404.

#### Optional Parameters ####

All methods accept the following optional parameters,

* **item**  
 In addition to the PDF document it is possible to access some intermediate data.

The formdata method accepts the following optional parameter,

* **step**  
 An explicit document step number. Default is the latest step.

 A *step* parameter has no effect with a *docboxRef*.

#### Valid item Names ####


* **pdf**  
 The default item name
* **docbook.xml**  
 Get the DocBook source XML
* **convlog**  
 PDF conversion log
* **preview**  
 A plain text preview (probably not very useful)
* **rdf.xml**  
 RDF metadata that was inserted into the document

### Get Original Form Data ###

Get form data XML from which the document was originally created. Also get an auxiliary XML structure that links control and section names to labels.

```
GET /docbox/doc/input/$docboxRef
```

The method returns 200 and a JSON structure on success, 404 if the document is not found, 409 if the document is found, but not form data.

The JSON structure contains the following elements.


* **formData**  
 Form data as generated by Orbeon
* **formXref**  
 An XML structure (see below)
* **timestamp**  
 Point in time when the document was created

The *formXref* structure contains the following elements.


* **xref**  
 Attributes: `title` (the form title), `uuid` (form data uuid)
* **section**  
 Attribute: `name` (section name, example: `section-3`). The element contains the section label.
* **control**  
 Attribute: `name` (control name, example: `section-7`). The element contains the control label.

### Add Signature ###

Add a signature to a document step, creating a new step. The signature applies to all contents up to and including the existing step. Any number of signatures may be added to a document.

```
POST /docbox/doc/sig/$docboxRef
```
The body of the request must contain a Base64-encoded XML-DSIG (returned by a signing service). The method checks its syntax and extracts the signed text. The signed text is text that prompts the user to sign the document. The signed text must contain the [document number] and [checksum] in brackets if strict checking is configured.

Example: The signed text may be

```
I sign this document with document number [8SJPTG-1] and checksum
[A32n2HnwEHO9L6V6FtVd598u/ae//NS366yAlEFwO1w=]
```
The document number and checksum must agree with the document being signed.

The signature is added to the document identified by *docboxRef*. A new document step is created. A JSON structure containing document metadata is returned (example, newlines added for clarity),

```
{"docboxRef":"3125af95-b830-4536-bad5-529207650da5",
 "docNo":"8SJPTG-1",
 "signCount":1,
 "checkSum":"A32n2HnwEHO9L6V6FtVd598u/ae//NS366yAlEFwO1w="
}
```
where

* **docboxRef**  
 A reference to the new document step (different from the posted one)
* **docNo**  
 A document number identifying the new document step
* **signCount**  
 The number of signatures in the new document step
* **checkSum**  
 A cryptographic hash of the contents of the new document step

#### HTTP Status & Errors ####

The method returns one of the following HTTP status codes,

* 200 (OK)
* 400 (Bad request) if the signature syntax is invalid
* 403 (Forbidden) if the document number and/or the checksum in the signed text do not agree with the document being signed
* 404 (Not found) if the document was not found
* 409 (Conflict) on concurrent update conflict

A concurrent update conflict occurs if the target document step is not the latest. This means that someone else has updated the document.

### Get All Signatures ###

Get information about all signatures in the document.

```
GET /doc/sig/$docboxRef
```

409 if the document is found but no signatures.
The method returns status 200 and a JSON data structure on success, 404 if the document is not found,

The JSON structure contains the following elements,

* **docboxRef**  
 The docboxRef of the examined document
* **docNo**  
 The document number of the examined document
* **signCount**  
 The number of signatures in the document according to the database
* **signExtracted**  
 The number of signatures actually extracted from the document
* **signatures**  
 An array of signature objects

Each signature object contains the following elements,

* **signedDoc**  
 Document number of the signed document
* **signedChecksum**  
 The signed checksum
* **signedText**  
 The text that was signed
* **signedBy**  
 The DN of the person who signed

### Validate Signature ###

Validate the last signature of a document step. Checks that the pieces of a signature link correctly to each other and that all checksums are correct. This is a semantic validation different from the validation in *Add Signature* that only checks the syntax.

```
GET /docbox/doc/sig/validate/$docboxRef
```

A JSON structure containing some metadata and a validation report is returned (example, newlines added for clarity),

```
{"docboxRef":"3125af95-b830-4536-bad5-529207650da5",
 "docNo":"8SJPTG-1",
 "signCount":1,
 "signedChecksum":"Es4GTFgyO9MjrzJqxlX3mKfSNaTUWuKbpy/R7U5ahJI=",
 "signedText": "...",
 "coreSigValid":true,
 "certValid":true,
 "validationReport":"..."
}
```
where

* **docboxRef**  
 A reference to the validated document step
* **docNo**  
 A document number identifying the validated document step
* **signCount**  
 The number of signatures in the validated document step
* **signedChecksum**  
 The checksum of the document in the previous document step
* **signedText**  
 The text that the user has been asked to sign
* **coreSigValid**  
 The outcome of core signature validation (true/false)
* **certValid**  
 The outcome of certificate validation (true/false)
* **validationReport**  
 Several lines of text presenting the validation result

#### HTTP Status & Errors ####

The method returns one of the following HTTP status codes,

* 200 (OK) if validation ended without apparent conflicts
* 400 (Bad request) if the document step does not contain a signature
* 404 (Not found) if the document was not found
* 409 (Conflict) if validation failed

## Förslag till tjänster att implementera ##

Fundera på om de hänger ihop bra...och fixa namngivningen enligt Håkans förslag.

### Skapa första version (=0) genom att ladda upp PDF/a ###

| Tjänst | Parameter | Datatyp |
|--------|-----------|---------|
| createInitialDocBoxReference  |  docId | String |
|   |  pdf/a | binär data |
| **Returns** || docboxuuid som identifierar docId och version samt att det finns en pdf/a (om PDF/A inte finns så ska den skapas, annars returnera fel)

Ifall det redan finns för docId, returnera lämplig felkod och dokumentera det.

