# Digitally Signed Forms in Motrice #

Motrice allows an end user to fill out a form and then to sign it digitally. The form is converted to a PDF document before being signed. One or more signatures may be added to the document. Each signature adds a page to the document and signs all preceding pages without affecting them. In summary, the PDF document is a container holding

* Form data filled out by a user
* A visual rendering of form data
* Form and document metadata
* Any number of signatures

The following text is a technical description of PDF documents generated by Motrice.

## Format ##

The format is PDF/A-1, standardised as ISO 19005-1:2005. It is based on PDF Reference Version 1.4. There are two levels, 1a and 1b. Motrice uses PDF/A-1a.

PDF/A has restrictions on its contents in order to support archival preservation.


* Audio and video content is forbidden.
* JavaScript and executable file launches are forbidden.
* All fonts must be embedded and also must be legally embeddable for unlimited, universal rendering. This also applies to the so-called PostScript standard fonts such as Times or Helvetica.
* Colorspaces specified in a device-independent manner.
* Encryption is forbidden.
* Use of standards-based metadata is mandated.
* External content references are forbidden.
* LZW and JPEG2000 image compressions are forbidden in PDF/A-1, but JPEG 2000 compression is allowed in PDF/A-2.
* Transparent objects and layers (Optional Content Groups) are forbidden in PDF/A-1, but they are supported in PDF/A-2.

## Metadata ##

Every filled-out form is identified by a uuid, the *form data uuid*. The form data uuid is intended for machine to machine communication. It consists of 40 hexadecimal digits.

The PDF document generated from a filled-out form is assigned a unique *document number*. A document number is short and readable. It may be used in person to person communication, if the need arises. Example: `FDZ8Q8`.

Some metadata appears visibly in the PDF document in a table added after form data. The exact set of visible metadata is subject to change, but typically includes,

* Document number
* Creation timestamp
* Form name and version
* Form data uuid

Another set of metadata is included as a RDF packet in XML format. It is not visible in the document, except that title and description appear as document properties. The inclusion is done in a way that allows non-PDF-aware software to read this metadata. The RDF packet consists of some of the Dublin Core Elements:

* **dc:format**  
 An URI identifying the exact format of the PDF document
* **dc:identifier**  
 A document number
* **dc:source**  
 A form data uuid
* **dc:relation**  
 The name and version of the underlying form
* **dc:title**  
 The title of the form
* **dc:description**  
 A short description of the form
* **dc:date**  
 The point in time when the PDF document was created

## Motrice Data Storage ##

This section describes how Motrice data is stored in a PDF document.

Every instance of Motrice data is stored as an XObject (strictly speaking a *form XObject*, but the term *form* is confusing because it has nothing to do with forms as in Orbeon forms). The XObject is stored as a resource in a page dictionary. It contains the key `/org.motrice.docbox.info`. The corresponding value is a dictionary that, in turn, always contains the following entries,

* **/DocBoxType**  
 The type of Motrice value, a fully qualified class name
* **/Format**  
 A URL pointing to a web page defining the format
* **/Timestamp**  
 Point in time when the dictionary was created

The dictionary contains additional entries according to its type, as described in the following subsections.

### Form Data ###

The original XML form data is stored in the document and may be extracted by software. It is a dictionary as described above and with the following entries.

* **/DocBoxType**  
 `org.motrice.docbox.pdf.PdfFormdataDict`
* **/FormData**  
 The original form data XML
* **/FormXref**  
 A cross reference tying labels to the various controls (also XML format)

Sections and controls in form data has names like `section-1` or `control-3`. The cross reference links readable labels to these names.

### Signatures ###

Signatures in the PDF document use the fact that a PDF document may be modified in append mode. A signature signs a cryptographic checksum of all existing pages of the PDF document. A new page is added to the document without disturbing the previous checksum. The new page is used to store the signature. The page contains a visible rendering of some signature data.

The cryptographic checksum includes all preceding signatures when signing a document that already contains one or more signatures.

Signature data is stored in the page dictionary of the new page. It is a dictionary with the format described above, and with the following entries.

* **/DocBoxType**  
 `org.motrice.docbox.sign.PdfSignatureDict`
* **/Checksum**  
 The signed checksum computed as SHA-256, then Base64-encoded
* **/DocNo**  
 The signed document number
* **/Signature**  
 The signature itself, a Base64-encoded piece of XML

Some signature data also appear visibly in a table on the page.

